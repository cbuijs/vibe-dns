# =============================================================================
# VIBE-DNS CONFIGURATION
# =============================================================================

# =============================================================================
# 1. LOGGING CONFIGURATION
# =============================================================================
logging:
  level: "DEBUG"
  enable_console: true
  console_timestamp: false
  enable_file: false
  file_path: "./dns_server.log"
  enable_syslog: false
  syslog_address: "/dev/log"
  syslog_protocol: "UDP"

# =============================================================================
# 2. SERVER NETWORKING
# =============================================================================
server:
  bind_interfaces:
    - "lo"
    - "eth0"
  
  port_udp: [53]
  port_tcp: [53]
  
  use_ecs: true
  use_edns_mac: true
  
  forward_ecs_mode: "preserve"  # none, preserve, add
  forward_mac_mode: "preserve"  # none, preserve, add

# =============================================================================
# 3. GEOIP CONFIGURATION
# Configure GeoIP for geographic filtering.
# =============================================================================
geoip:
  enabled: false
  
  # CCTLD (Country Code TLD) hint mode
  # Controls how domain TLDs are used for geographic hints
  #
  # Modes:
  #   geoip_only (default):
  #     - Use only GeoIP lookups, ignore domain TLD
  #     - Fastest, most reliable
  #
  #   cctld_first:
  #     - Check domain TLD first (e.g., .nl, .de, .fr)
  #     - If TLD matches location, accept immediately
  #     - If TLD doesn't match, fallback to GeoIP
  #     - Useful for performance when domains are trustworthy
  #
  #   cctld_geoip:
  #     - Require BOTH TLD and GeoIP to match
  #     - Highest confidence, but may reject valid traffic
  #     - Example: company.nl hosted in US would be REJECTED
  #     - Use for high-security scenarios
  #
  cctld_mode: "geoip_only"
  
  # Path to unified database (RECOMMENDED - compile with geoip_compiler.py)
  #
  # Compilation:
  #   python3 geoip_compiler.py --mmdb ./geoip/GeoLite2-Country.mmdb
  #
  # Benefits:
  #   - 3-4x faster lookups (single operation vs multiple)
  #   - Pre-computed region memberships
  #   - Optimized IP range aggregation
  #   - Full region support (BENELUX, SCANDINAVIA, EU_MEMBERS, etc.)
  #
  unified_database: "./geoip_unified.db"
  
  # Fallback: MMDB database (LIMITED functionality)
  #
  # MaxMind GeoLite2 (Free, requires account):
  #   Download from: https://dev.maxmind.com/geoip/geolite2-free-geolocation-data
  #
  # IPInfo (Free tier available):
  #   Download from: https://ipinfo.io/developers/database-download
  #
  # Note: MMDB fallback only supports country/continent codes.
  #       Custom regions (BENELUX, BALKANS, etc.) require unified DB.
  #
  # database_path: "./geoip/GeoLite2-Country.mmdb"

# =============================================================================
# 4. UPSTREAM RESOLUTION
# =============================================================================
upstream:
  startup_check_enabled: true
  fallback_enabled: false
  allow_underscores: false
  mode: "loadbalance"
  monitor_interval: 60
  monitor_on_query: true
  test_domain: "www.google.com"
  
  bootstrap:
    - "udp://86.54.11.1:53"
    - "udp://86.54.11.201:53"
    - "udp://[2a13:1001::86:54:11:1]:53"
    - "udp://[2a13:1001::86:54:11:201]:53"

  groups:
    Default:
      servers:
        - "https://protective.joindns4.eu:443/dns-query#86.54.11.1"
        - "https://protective.joindns4.eu:443/dns-query#86.54.11.201"
        - "https://protective.joindns4.eu:443/dns-query#2a13:1001::86:54:11:1"
        - "https://protective.joindns4.eu:443/dns-query#2a13:1001::86:54:11:201"
    
    Filtered:
      servers:
        - "https://child-noads.joindns4.eu:443/dns-query#86.54.11.11"
        - "https://child-noads.joindns4.eu:443/dns-query#86.54.11.211"
        - "https://child-noads.joindns4.eu:443/dns-query#2a13:1001::86:54:11:11"
        - "https://child-noads.joindns4.eu:443/dns-query#2a13:1001::86:54:11:211"
      
# =============================================================================
# 5. CACHING & PERFORMANCE
# =============================================================================
cache:
  size: 10000
  gc_interval: 300
  negative_ttl: 60
  prefetch_margin: 10
  prefetch_min_hits: 3

decision_cache:
  size: 2500
  ttl: 300

deduplication:
  enabled: true

# =============================================================================
# 6. RATE LIMITING
# =============================================================================
rate_limit:
  enabled: true
  window_seconds: 60
  ipv4_mask: 24
  ipv6_mask: 64
  udp_threshold: 100
  total_threshold: 200

# =============================================================================
# 7. RESPONSE MODIFICATION & BLOCKING BEHAVIOR
# =============================================================================
response:
  round_robin_enabled: true
  cname_collapse: true
  minimize_response: false
  
  min_ttl: 60
  max_ttl: 14400
  ttl_sync_mode: "last"  # none, lowest, highest, average, first, last
  
  # IP blocking behavior when answer contains blocked IP/CIDR
  ip_block_mode: "filter"  # filter (remove record) or block (block entire response)
  
  # DNS Response Code for BLOCK action
  block_rcode: "REFUSED"  # REFUSED, NXDOMAIN, NOERROR, SERVFAIL
  
  # TTL for synthetic blocked responses
  block_ttl: 60
  
  # IP injection for blocks (sinkholing)
  # "NULL" returns 0.0.0.0/::, or specify custom IP like "10.0.0.1"
  block_ip: "NULL"
  
  # Apply blocklists to CNAME targets and IPs in answers
  match_answers_globally: false

# =============================================================================
# 8. CATEGORIZATION
# =============================================================================
categorization_enabled: true
categories_file: "categories.json"

# =============================================================================
# 9. CLIENT GROUPS & IDENTIFICATION
# 
# Groups can match clients by:
# - server_ip:<ip>       - Match by listening server IP
# - server_port:<port>   - Match by listening port
# - geoip:<LOCATION>     - Match by geographic location (requires GeoIP enabled)
# - <mac_address>        - Match by client MAC
# - <ip_address>         - Match by client IP
# - <cidr_range>         - Match by IP subnet
#
# GeoIP location formats:
# - ISO 3166 country code: geoip:NL, geoip:DE, geoip:US
# - Full country name: geoip:NETHERLANDS, geoip:GERMANY, geoip:FRANCE
# - Continent: geoip:EUROPE, geoip:ASIA, geoip:AFRICA
# - Region: geoip:BALKANS, geoip:SCANDINAVIA, geoip:MIDDLE_EAST
# =============================================================================
mac_cache_refresh_interval: 300

groups:
  kids_devices:
    - "48:db:50:38:8a:94"
    - "4c:8d:79:d5:b3:04"
    - "192.168.1.20"
    - "192.168.1.21"
    - "10.1.1.0/24"
  
  guest_network:
    - "172.16.1.0/24"
  
  # Example: EU clients only
  eu_clients:
    - "geoip:EUROPE"
  
  # Example: Specific countries
  netherlands_clients:
    - "geoip:NL"
    - "geoip:NETHERLANDS"

group_files:
  kids_devices: "./groups/kids_devices.txt"
  guest_network: "./groups/guest_network.txt"
  iot_devices: "./groups/iot_devices.txt"
  refresh_interval: 300

# =============================================================================
# 10. SCHEDULES
# =============================================================================
schedules:
  bedtime:
    - { days: ["Mon", "Tue", "Wed", "Thu", "Sun"], start: "21:00", end: "07:00" }
  
  school_hours:
    - { days: ["Mon", "Tue", "Wed", "Thu", "Fri"], start: "08:30", end: "15:30" }

# =============================================================================
# 11. POLICY ASSIGNMENTS
# =============================================================================
assignments:
  kids_devices:
    policy: "StrictPolicy"
    schedule: "bedtime"
    schedule_policy: "BLOCK"
  
  guest_network:
    policy: "GuestPolicy"
  
  # Example: Block non-EU traffic
  eu_clients:
    policy: "EUPolicy"

# =============================================================================
# 12. FILTER LISTS & CATEGORIZATION
#
# Rules can be:
# - Domains: example.com, .example.com, *.example.com
# - Regex: /pattern/
# - IPs/CIDR: 1.2.3.4, 10.0.0.0/8
# - GeoIP (answer-only): @@NL, @@EUROPE, @@ASIA
#
# Rule prefixes:
# - @ = Answer-only rule (blocks IPs/domains in DNS responses, not queries)
# - @@ = GeoIP answer-only rule (blocks responses from specific countries/regions)
#
# Examples:
# - @1.2.3.4          - Block this IP in answers
# - @.ad-tracker.com  - Block this domain in CNAME chains
# - @@CN              - Block IPs from China in answers
# - @@RUSSIA          - Block IPs from Russia in answers
# - @@ASIA            - Block all Asian IPs in answers
# =============================================================================
lists:
  ads_basic:
    - source: "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"
      hosts_domain_type: "inclusive"
  
  custom_block:
    - source: "block.list"
      hosts_domain_type: "inclusive"
  
  custom_drop:
    - source: "drop.list"
      hosts_domain_type: "exact"
  
  custom_allow:
    - source: "allow.list"
      hosts_domain_type: "exact"
  
  # Example: Block responses from specific countries
  geoip_block:
    - source: "geoip_block.list"
      hosts_domain_type: "exact"
  # Example content of geoip_block.list:
  # @@CN       # Block China IPs in answers
  # @@RU       # Block Russia IPs in answers
  # @@KP       # Block North Korea IPs in answers

# =============================================================================
# 13. POLICIES
#
# Actions available:
# - allow: Domain/IP is explicitly allowed
# - block: Return block response (REFUSED/NXDOMAIN/etc.)
# - drop:  Silent drop, no response sent (useful for tracking/telemetry domains)
#
# Type filters:
# - allowed_types: Whitelist of allowed query types (blocks all others)
# - blocked_types: Blacklist of blocked query types (returns block response)
# - dropped_types: Query types to silently drop (no response)
#
# Category rules support actions:
# - ALLOW: Allow this category
# - BLOCK: Block this category (return block response)
# - DROP:  Drop queries for this category (no response)
# =============================================================================
policies:
  DefaultPolicy:
    upstream_group: "Default"
    
  StrictPolicy:
    upstream_group: "Filtered"
    allow:
      - "custom_allow"
    block:
      - "ads_basic"
      - "custom_block"
    drop:
      - "custom_drop"  # Silent drop for tracking domains
    allowed_types: 
      - "A"
      - "AAAA"
      - "CNAME"
      - "HTTPS"
      - "SVCB"
    category_rules:
      gambling:
        min_confidence: 85
        action: "BLOCK"
      social_media:
        min_confidence: 60
        action: "BLOCK"
      tracking:
        min_confidence: 70
        action: "DROP"  # Silent drop for trackers
      
  GuestPolicy:
    upstream_group: "Default"
    block:
      - "ads_basic"
    dropped_types:
      - "ANY"      # Drop ANY queries (abuse prevention)
      - "AXFR"     # Drop zone transfer attempts
      - "IXFR"
    category_rules:
      gambling:
        min_confidence: 85
        action: "BLOCK"
  
  # Example: Block non-EU responses
  EUPolicy:
    upstream_group: "Default"
    block:
      - "ads_basic"
      - "geoip_block"  # Block answers from blocked countries
    category_rules:
      tracking:
        min_confidence: 80
        action: "DROP"

