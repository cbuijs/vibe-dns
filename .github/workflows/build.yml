# ==============================================================================
# Vibe-DNS Automated Build & Release Pipeline (Stable Python 3.12)
# ==============================================================================
# This workflow compiles Python scripts into standalone executables for:
#   - Linux (Generic glibc 2.28+ compatibility via Manylinux container)
#   - Windows (x86_64)
#   - macOS (Apple Silicon / ARM64)
# ==============================================================================

name: Build Vibe-DNS Binaries

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.platform_name }}
    runs-on: ${{ matrix.os }}
    # Only use a container if defined (for Linux)
    container: ${{ matrix.container_image }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Linux (Generic / Manylinux) ---
          # Built inside AlmaLinux 8 container (glibc 2.28)
          # Compatible with Ubuntu 20.04+, Debian 10+, RHEL 8+
          - os: ubuntu-latest
            platform_name: linux-amd64
            container_image: quay.io/pypa/manylinux_2_28_x86_64
            executable_ext: ""

          # --- Windows (x86_64) ---
          - os: windows-latest
            platform_name: windows-amd64
            container_image: null
            executable_ext: ".exe"

          # --- macOS (Apple Silicon) ---
          - os: macos-14
            platform_name: macos-arm64
            container_image: null
            executable_ext: ""

    steps:
    - uses: actions/checkout@v4

    # 1. SETUP PYTHON (Linux Container)
    # The manylinux image has pre-installed Python versions in /opt/python.
    # We add Python 3.12 to the PATH manually.
    - name: Setup Python 3.12 (Linux)
      if: matrix.platform_name == 'linux-amd64'
      run: |
        echo "/opt/python/cp312-cp312/bin" >> $GITHUB_PATH

    # 2. SETUP PYTHON (Windows/Mac)
    # Standard setup action for non-container jobs.
    - name: Setup Python 3.12 (Windows/Mac)
      if: matrix.platform_name != 'linux-amd64'
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    # 3. INSTALL DEPENDENCIES
    - name: Install Dependencies
      run: |
        # Git safety fix for containers
        git config --global --add safe.directory '*' || true
        
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # 4. BUILD SERVER
    - name: Build Server Binary
      run: |
        pyinstaller --clean --onefile --name vibe-dns-server${{ matrix.executable_ext }} server.py

    # 5. BUILD COMPILER
    - name: Build GeoIP Compiler Binary
      run: |
        pyinstaller --clean --onefile --name geoip-compiler${{ matrix.executable_ext }} geoip_compiler.py

    # 6. ORGANIZE ARTIFACTS
    - name: Prepare Release Artifacts
      shell: bash
      run: |
        mkdir -p release
        
        # Move binaries
        mv dist/vibe-dns-server${{ matrix.executable_ext }} release/
        mv dist/geoip-compiler${{ matrix.executable_ext }} release/
        
        # Copy config files
        cp full_config.yaml release/config.yaml
        cp categories.json release/
        cp geoip.txt release/

    # 7. UPLOAD ARTIFACTS (Workflow Summary)
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vibe-dns-${{ matrix.platform_name }}
        path: release/

    # 8. PUBLISH RELEASE (On Tag Only)
    - name: Publish to GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          release/vibe-dns-server${{ matrix.executable_ext }}
          release/geoip-compiler${{ matrix.executable_ext }}
          release/config.yaml
          release/categories.json
          release/geoip.txt

