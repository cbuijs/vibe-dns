# ==============================================================================
# Vibe-DNS Automated Build & Release Pipeline
# ==============================================================================
# This workflow compiles Python scripts into standalone executables for:
#   - Linux (Generic glibc 2.31+ compatibility via Debian 11 container)
#   - Windows (x86_64)
#   - macOS (Apple Silicon / ARM64)
#
# NAMING CONVENTION:
# Executables are now named per-platform, e.g.:
#   vibe-dns-server-linux-amd64
#   geoip-compiler-windows-amd64.exe
# ==============================================================================

name: Build Vibe-DNS Binaries

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.platform_name }}
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container_image }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Linux (Generic) ---
          # Compatibility: Ubuntu 20.04+, Debian 11+, RHEL 9+.
          - os: ubuntu-latest
            platform_name: linux-amd64
            container_image: python:3.12-bullseye
            executable_ext: ""

          # --- Windows (x86_64) ---
          - os: windows-latest
            platform_name: windows-amd64
            container_image: null
            executable_ext: ".exe"

          # --- macOS (Apple Silicon) ---
          - os: macos-14
            platform_name: macos-arm64
            container_image: null
            executable_ext: ""

    steps:
    - uses: actions/checkout@v4

    # 1. SETUP PYTHON (Linux)
    - name: Configure Python (Linux)
      if: matrix.platform_name == 'linux-amd64'
      run: git config --global --add safe.directory '*'

    # 2. SETUP PYTHON (Windows/Mac)
    - name: Setup Python (Windows/Mac)
      if: matrix.platform_name != 'linux-amd64'
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    # 3. INSTALL DEPENDENCIES
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # 4. BUILD SERVER (With Precise Naming)
    - name: Build Server Binary
      run: |
        pyinstaller --clean --onefile \
          --name vibe-dns-server-${{ matrix.platform_name }}${{ matrix.executable_ext }} \
          server.py

    # 5. BUILD COMPILER (With Precise Naming)
    - name: Build GeoIP Compiler Binary
      run: |
        pyinstaller --clean --onefile \
          --name geoip-compiler-${{ matrix.platform_name }}${{ matrix.executable_ext }} \
          geoip_compiler.py

    # 6. ORGANIZE ARTIFACTS
    - name: Prepare Release Artifacts
      shell: bash
      run: |
        mkdir -p release
        
        # Move the specifically named binaries
        mv dist/vibe-dns-server-${{ matrix.platform_name }}${{ matrix.executable_ext }} release/
        mv dist/geoip-compiler-${{ matrix.platform_name }}${{ matrix.executable_ext }} release/
        
        # Copy config files
        cp full_config.yaml release/config.yaml
        cp categories.json release/
        cp geoip.txt release/

    # 7. UPLOAD ARTIFACTS (For Inspection)
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vibe-dns-${{ matrix.platform_name }}
        path: release/

    # 8. PUBLISH RELEASE (On Tag Only)
    - name: Publish to GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          release/vibe-dns-server-${{ matrix.platform_name }}${{ matrix.executable_ext }}
          release/geoip-compiler-${{ matrix.platform_name }}${{ matrix.executable_ext }}
          release/config.yaml
          release/categories.json
          release/geoip.txt

